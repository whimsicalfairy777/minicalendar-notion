import React, { useState, useEffect } from "react";
import { format, startOfMonth, endOfMonth, eachDayOfInterval, getDay } from "date-fns";
import { motion } from "framer-motion";
import "tailwindcss/tailwind.css";

const CalendarWidget = () => {
  const [selectedDate, setSelectedDate] = useState(null);
  const [databaseId, setDatabaseId] = useState("");
  const [notionData, setNotionData] = useState(null);

  const currentMonth = new Date();
  const days = eachDayOfInterval({
    start: startOfMonth(currentMonth),
    end: endOfMonth(currentMonth),
  });

  useEffect(() => {
    if (selectedDate && databaseId) {
      fetchNotionData(selectedDate);
    }
  }, [selectedDate, databaseId]);

  const fetchNotionData = async (date) => {
    const notionAPIKey = "your-secret-api-key"; // Replace with actual API key
    const formattedDate = format(date, "yyyy-MM-dd");
    
    const response = await fetch("https://api.notion.com/v1/databases/" + databaseId + "/query", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${notionAPIKey}`,
        "Content-Type": "application/json",
        "Notion-Version": "2022-06-28",
      },
      body: JSON.stringify({
        filter: {
          property: "Date",
          date: {
            equals: formattedDate,
          },
        },
        page_size: 1,
      }),
    });
    const data = await response.json();
    setNotionData(data.results[0] || null);
  };

  return (
    <div className="bg-[#242B26] text-white p-4 rounded-xl w-80 shadow-lg">
      <h2 className="text-lg font-bold text-center">{format(currentMonth, "MMMM yyyy")}</h2>
      <div className="grid grid-cols-7 gap-2 mt-4">
        {[...Array(getDay(days[0]))].map((_, i) => (
          <div key={i} className="opacity-0">-</div>
        ))}
        {days.map((day) => (
          <motion.button
            key={day}
            whileTap={{ scale: 0.9 }}
            onClick={() => setSelectedDate(day)}
            className="p-2 rounded-md text-center transition duration-200 hover:bg-green-500"
          >
            {format(day, "d")}
          </motion.button>
        ))}
      </div>
      <div className="mt-4">
        <input
          type="text"
          placeholder="Enter Notion Database ID"
          className="w-full p-2 text-black rounded-md"
          value={databaseId}
          onChange={(e) => setDatabaseId(e.target.value)}
        />
      </div>
      {notionData && (
        <div className="mt-4 bg-gray-800 p-3 rounded-md">
          <h3 className="font-bold">Entry for {format(selectedDate, "PPP")}:</h3>
          <p>{notionData.properties.Name.title[0]?.plain_text || "No data found"}</p>
        </div>
      )}
    </div>
  );
};

export default CalendarWidget;
